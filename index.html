<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sunil TTS ‚Äî English + Hindi (Presets)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#071321;--card:#0b1220;--muted:#9aa6b2;--accent:#6f5cff}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;color:#e6eef6;background:
  radial-gradient(800px 300px at 10% 10%, rgba(111,92,255,0.10), transparent),var(--bg);padding:18px;min-height:100vh;display:flex;align-items:center;justify-content:center}
  .wrap{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#00b5ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#041428}
  h1{margin:0;font-size:18px} .lead{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:14px}
  @media(max-width:920px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  textarea{width:100%;min-height:200px;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:inherit;resize:vertical;font-size:15px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{background:linear-gradient(180deg,var(--accent),#5e3bff);color:#fff;padding:10px 12px;border-radius:10px;border:none;font-weight:600;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
  select,input[type=range]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:inherit}
  .small{font-size:13px;color:var(--muted)}
  .voices-list{max-height:140px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02)}
  footer{display:flex;justify-content:space-between;margin-top:12px;font-size:13px;color:var(--muted)}
  .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px}
  .hint{font-size:13px;color:var(--muted);margin-top:10px}
</style>
</head>
<body>
<div class="wrap" role="main">
  <header>
    <div class="logo">TTS</div>
    <div>
      <h1>Sunil TTS ‚Äî English & Hindi</h1>
      <p class="lead">10+ presets ‚Ä¢ Play ‚Ä¢ Download (Server) ‚Ä¢ Download (Robotic) ‚Ä¢ Mobile friendly</p>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <textarea id="text" placeholder="Type text here... (English or Hindi)">Hello! This is a demo. Type anything and test the presets.</textarea>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <div style="flex:1">
          <label class="small">Preset</label>
          <select id="preset"></select>
        </div>
        <div style="width:160px">
          <label class="small">Voice (device)</label>
          <select id="voice"></select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <div style="flex:1">
          <label class="small">Speed</label>
          <input id="rate" type="range" min="0.6" max="1.8" step="0.05" value="1.0">
          <div class="small">Value: <span id="rateVal">1.0</span></div>
        </div>
        <div style="width:160px">
          <label class="small">Pitch</label>
          <input id="pitch" type="range" min="0.5" max="2.0" step="0.05" value="1.0">
          <div class="small">Value: <span id="pitchVal">1.0</span></div>
        </div>
      </div>

      <div class="controls">
        <button id="play" class="btn">‚ñ∂ Generate & Play</button>
        <button id="pause" class="btn secondary">‚è∏ Pause</button>
        <button id="resume" class="btn secondary">‚ñ∂ Resume</button>
        <button id="stop" class="btn secondary">‚úñ Stop</button>
        <button id="downloadServer" class="btn">‚¨á Download (Server)</button>
        <button id="downloadRobot" class="btn">‚§ì Download (Robotic)</button>
        <button id="copy" class="btn secondary">üìã Copy</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <div class="pill">English + Hindi</div><div class="pill">No paid API</div><div class="pill">Mobile-first</div>
      </div>

      <div class="hint">
        <strong>Note:</strong> Use <em>Download (Server)</em> on iPhone for reliable MP3 downloads. <em>Download (Robotic)</em> is client-side (meSpeak) ‚Äî works best on Android/Desktop.
      </div>
    </div>

    <aside>
      <div class="card" style="margin-bottom:10px">
        <div>
          <label class="small">Language Filter</label>
          <select id="lang">
            <option value="">All</option>
            <option value="en">English</option>
            <option value="hi">Hindi</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <label class="small">Available voices (device)</label>
          <div id="voicesWrap" class="voices-list small">Loading voices...</div>
        </div>
      </div>

      <div class="card small">
        <strong>Notes</strong>
        <ol>
          <li>Device voices vary. Android Chrome gives most voices.</li>
          <li>Server download calls: <code>https://nikhil-ai-tts-backend.onrender.com/tts</code> (already configured).</li>
          <li>If you want me to remove server and use only client-side, tell me.</li>
        </ol>
      </div>
    </aside>
  </div>

  <footer>
    <div>Made for you ‚Ä¢ Mobile ready</div>
    <div id="localTime"></div>
  </footer>
</div>

<script>
  // Local time
  const localTime = document.getElementById('localTime');
  function updateLocalTime(){ localTime.textContent = new Date().toLocaleString(); }
  updateLocalTime(); setInterval(updateLocalTime,60000);

  // UI refs
  const textEl = document.getElementById('text');
  const playBtn = document.getElementById('play');
  const pauseBtn = document.getElementById('pause');
  const resumeBtn = document.getElementById('resume');
  const stopBtn = document.getElementById('stop');
  const copyBtn = document.getElementById('copy');
  const downloadRobot = document.getElementById('downloadRobot');
  const downloadServer = document.getElementById('downloadServer');

  const voiceSelect = document.getElementById('voice');
  const presetSelect = document.getElementById('preset');
  const langFilter = document.getElementById('lang');
  const voicesWrap = document.getElementById('voicesWrap');

  const rateEl = document.getElementById('rate'), pitchEl = document.getElementById('pitch');
  const rateVal = document.getElementById('rateVal'), pitchVal = document.getElementById('pitchVal');

  rateEl.addEventListener('input', ()=> rateVal.textContent = rateEl.value);
  pitchEl.addEventListener('input', ()=> pitchVal.textContent = pitchEl.value);

  // SpeechSynthesis
  let synth = window.speechSynthesis;
  let voices = [];

  function loadVoices(){
    voices = synth.getVoices() || [];
    const filtered = voices.filter(v => v.lang && (v.lang.toLowerCase().startsWith('en') || v.lang.toLowerCase().startsWith('hi')));
    populateVoiceList(filtered);
    renderVoicesPanel(filtered);
    populatePresets();
  }

  function populateVoiceList(list){
    voiceSelect.innerHTML = '';
    list.forEach((v,i)=>{
      const opt = document.createElement('option');
      opt.value = v.name+'|'+v.lang;
      opt.textContent = `${v.name} ‚Äî ${v.lang}${v.localService ? ' ‚Ä¢ local' : ''}`;
      voiceSelect.appendChild(opt);
    });
  }

  function renderVoicesPanel(list){
    if(!list.length){
      voicesWrap.innerHTML = '<div style="padding:8px;color:var(--muted)">No English/Hindi voices detected on this device yet.</div>';
      return;
    }
    voicesWrap.innerHTML = '';
    list.forEach(v=>{
      const d = document.createElement('div');
      d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.01)';
      d.innerHTML = `<strong>${v.name}</strong> <span style="float:right;color:var(--muted)">${v.lang}</span><div class="small" style="clear:both;color:var(--muted)">${v.localService ? 'Local' : 'Remote'}</div>`;
      voicesWrap.appendChild(d);
    });
  }

  // PRESETS (frontend)
  const PRESETS = [
    {id:'deep_american', label:'Deep American Male', lang:'en', pitch:0.7, rate:0.92},
    {id:'deep_calm', label:'Deep Calm Male', lang:'en', pitch:0.65, rate:0.9},
    {id:'clear_neutral', label:'Clear Neutral Male', lang:'en', pitch:1.0, rate:1.0},
    {id:'english_female', label:'English Female', lang:'en', pitch:1.15, rate:1.02},
    {id:'hindi_male', label:'Hindi Male', lang:'hi', pitch:0.75, rate:0.95},
    {id:'hindi_female', label:'Hindi Female', lang:'hi', pitch:1.1, rate:1.02},
    {id:'robotic', label:'Robotic (server/meSpeak)', lang:'en', pitch:1.0, rate:1.0},
    {id:'fast_narrator', label:'Fast Narrator', lang:'en', pitch:1.0, rate:1.35},
    {id:'mixed_deep', label:'Mixed Deep', lang:'en', pitch:0.7, rate:0.95}
  ];

  function populatePresets(){
    presetSelect.innerHTML = '';
    PRESETS.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.label; presetSelect.appendChild(opt);
    });
  }

  // map frontend preset to server preset ids (server expects some ids)
  const SERVER_PRESET_MAP = {
    'deep_american':'deep_american',
    'deep_calm':'deep_calm',
    'clear_neutral':'clear_neutral',
    'english_female':'english_female',
    'hindi_male':'hindi_male',
    'hindi_female':'hindi_female',
    'robotic':'robotic',
    'fast_narrator':'fast_narrator',
    'mixed_deep':'mixed_deep'
  };
  function getServerPreset(frontendId){ return SERVER_PRESET_MAP[frontendId] || 'clear_neutral'; }

  // speak with device voices
  function findVoiceForPreset(preset){
    const cand = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith(preset.lang));
    if(cand.length) return cand[0];
    return voices[0] || null;
  }

  let currentUtterance = null;
  function speakText(){
    const txt = textEl.value.trim(); if(!txt) return alert('Enter text first.');
    if(synth.speaking) synth.cancel();
    const presetId = presetSelect.value;
    const preset = PRESETS.find(p=>p.id===presetId) || {};
    const u = new SpeechSynthesisUtterance(txt);
    // pick selected device voice if any
    const voiceVal = voiceSelect.value;
    if(voiceVal){
      const [name,lang] = voiceVal.split('|');
      const v = voices.find(x=>x.name===name && x.lang===lang);
      if(v) u.voice = v;
    } else if(preset.lang){
      const v = findVoiceForPreset(preset);
      if(v) u.voice = v;
    }
    u.rate = preset.rate || parseFloat(rateEl.value);
    u.pitch = preset.pitch || parseFloat(pitchEl.value);
    u.volume = 1.0;
    playBtn.textContent='üîä Playing...'; playBtn.disabled=true;
    u.onend = ()=> { playBtn.textContent='‚ñ∂ Generate & Play'; playBtn.disabled=false; };
    u.onerror = (e)=> { alert('Speech error: ' + (e?.error || e?.message || e)); playBtn.textContent='‚ñ∂ Generate & Play'; playBtn.disabled=false; };
    currentUtterance = u; synth.speak(u);
  }

  playBtn.addEventListener('click', speakText);
  pauseBtn.addEventListener('click', ()=> { if(synth.speaking && !synth.paused) synth.pause(); });
  resumeBtn.addEventListener('click', ()=> { if(synth.paused) synth.resume(); });
  stopBtn.addEventListener('click', ()=> { if(synth.speaking) synth.cancel(); });

  copyBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(textEl.value); copyBtn.textContent='Copied ‚úì'; setTimeout(()=>copyBtn.textContent='üìã Copy',1200); }catch(e){ alert('Clipboard not available: ' + e); }
  });

  // ----- Client-side meSpeak (robotic download) -----
  let meSpeakReady = false;
  (async function loadMeSpeak(){
    try{
      await loadScript('https://cdn.jsdelivr.net/npm/mespeak/mespeak.min.js');
      // load config and voice files as text to avoid CORS issues
      const cfg = await fetch('https://cdn.jsdelivr.net/npm/mespeak/mespeak_config.json').then(r=>r.text());
      const vjson = await fetch('https://cdn.jsdelivr.net/npm/mespeak/voices/en/en.json').then(r=>r.json());
      // inject config and voice
      const s = document.createElement('script'); s.type='application/javascript'; s.text = cfg; document.head.appendChild(s);
      meSpeak.loadVoice(vjson);
      meSpeakReady = true;
    }catch(e){
      meSpeakReady = false;
      // console.warn('meSpeak load failed', e);
    }
  })();

  downloadRobot.addEventListener('click', ()=>{
    if(!meSpeakReady){ alert('Offline engine not ready on this device. Try Download (Server) or use Android/PC.'); return; }
    const txt = textEl.value.trim(); if(!txt) return alert('Enter text first.');
    try{
      const wavBase64 = meSpeak.generateWAV(txt,{rawdata:false,wordgap:0});
      const byteCharacters = atob(wavBase64);
      const byteNumbers = new Array(byteCharacters.length);
      for(let i=0;i<byteCharacters.length;i++) byteNumbers[i]=byteCharacters.charCodeAt(i);
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray],{type:'audio/wav'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tts.wav'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(e){ alert('Download failed: ' + e); }
  });

  // ----- Server-based download (good for iPhone) -----
  // NOTE: server URL provided (already configured). If you deploy your own backend, replace this URL.
  const SERVER_TTS_URL = 'https://nikhil-ai-tts-backend.onrender.com/tts';

  async function downloadServerAudio(fmt='mp3'){
    const txt = textEl.value.trim(); if(!txt) return alert('Enter text first.');
    const preset = getServerPreset(presetSelect.value);
    try{
      downloadServer.textContent = 'Preparing...'; downloadServer.disabled = true;
      const res = await fetch(SERVER_TTS_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text: txt, preset: preset, format: fmt })
      });
      if(!res.ok){
        const j = await res.json().catch(()=>null);
        throw new Error(j?.error || 'Server error');
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `tts.${fmt}`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(e){
      alert('Download failed: ' + (e.message || e));
    }finally{
      downloadServer.textContent = '‚¨á Download (Server)'; downloadServer.disabled = false;
    }
  }
  downloadServer.addEventListener('click', ()=> downloadServerAudio('mp3'));

  // ---- helpers ----
  function loadScript(src, asText=false){
    return new Promise((resolve,reject)=>{
      if(asText){
        fetch(src).then(r=>r.text()).then(txt=>{
          const s = document.createElement('script'); s.type='application/javascript'; s.text = txt; document.head.appendChild(s); resolve();
        }).catch(reject);
        return;
      }
      const s = document.createElement('script'); s.src = src; s.onload = ()=> setTimeout(resolve,50); s.onerror = reject; document.head.appendChild(s);
    });
  }

  // voices changed
  if('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  // language filter
  langFilter.addEventListener('change', ()=>{
    const val = langFilter.value;
    const filtered = voices.filter(v => v.lang && (val ? v.lang.toLowerCase().startsWith(val) : (v.lang.toLowerCase().startsWith('en') || v.lang.toLowerCase().startsWith('hi')) ));
    populateVoiceList(filtered); renderVoicesPanel(filtered);
  });

  // fallback hint
  setTimeout(()=> { if(!voices.length) voicesWrap.innerHTML = '<div style="padding:8px;color:var(--muted)">No voices detected. Try Chrome on Android and ensure TTS voice data (Google) installed in device settings.</div>'; },800);

  // quick UX: select deep preset by default
  setTimeout(()=>{ if(presetSelect.options.length) presetSelect.value = 'deep_american'; },400);

  // accessibility
  textEl.addEventListener('keydown',(e)=>{ if(e.ctrlKey && e.key==='Enter') speakText(); });
  document.addEventListener('click', ()=>{ if(!voices.length) loadVoices(); }, {once:true});

  // Expose local image path you uploaded earlier (if you want to show it)
  // Local file path (already uploaded earlier): /mnt/data/IMG_0193.png
  console.log('If you want to reference your uploaded image: /mnt/data/IMG_0193.png');

</script>
</body>
</html>
